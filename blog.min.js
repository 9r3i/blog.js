/*** blog.js* ~ blog for website and blog* ~ one of gaino's apps* authored by 9r3i* https://github.com/9r3i/blog.js* started at november 21st 2023* requires:*   - virtual.js - https://github.com/9r3i/virtual.js - v1.0.0*   - gaino.js   - https://github.com/9r3i/gaino.js   - v1.0.0*   - router.js  - https://github.com/9r3i/router.js  - v2.0.2*   - parser.js  - https://github.com/9r3i/parser.js  - v1.2.6*/;function blog(g,v){Object.defineProperty(this,'version',{value:'1.3.1',writable:false,});Object.defineProperty(this,'virtual',{value:v,writable:false,});Object.defineProperty(this,'gaino',{value:g,writable:false,});this.config={};this.init=async function(chost){if(typeof eloader==='function'){(new eloader).fromProgressBar();}let app=this.virtual,cfile=chost.match(/([^\/]+)$/)[1];app.files[cfile]=chost,craw=app.get(cfile);if(!craw){craw=await app.update(cfile);}this.config=this.gaino.parseJSON(craw);if(!this.config||typeof this.config!=='object'||!this.config.hasOwnProperty('performTest')||!this.config.hasOwnProperty('database')||!this.config.hasOwnProperty('theme')||!this.config.hasOwnProperty('loader')){app.delete(cfile);alert('Error: Invalid config file.');return;}if(this.config.performTest){this.test(...arguments);}else{this.start();}/* doing silent self update,* and also update for config file */await app.update('blog.js');await app.update(cfile);};this.start=async function(a,b,c){let app=this.virtual;if(this.config.database.username=='___GITHUB_USER___'&&this.config.database.name=='___GITHUB_PUBLIC_REPO___'){let ptrn=/^\/([^\/]+)\/([^\/]+)\/?$/i,gh=window.location.pathname.match(ptrn);if(gh){this.config.database.username=gh[1];this.config.database.name=gh[2];this.config.across=true;document.querySelector('title').textContent=gh[1]+'/'+gh[2];}else if(window.location.pathname=='/'){this.config.database.username='9r3i';this.config.database.name='gaino-blog-data';this.config.across=false;document.querySelector('title').textContent='9r3i\\hunter';}else{alert('Error: Invalid pathname.');return;}}let driver=this.config.database.driver&&typeof window[this.config.database.driver]==='function'?this.config.database.driver:'BlogDatabaseDriver';this.db=new window[driver](this.config.database,this);this.route=new router(window.location.pathname.replace(/^\//,'').replace(/[^\/]+$/,''),{},[],[]);let dbpath=this.config.database.username+'/'+this.config.database.name,rawData=await app.get(dbpath),isUpdated=false,data=this.gaino.parseJSON(rawData);if(!data){data=await this.requestData();app.put(dbpath,JSON.stringify(data));isUpdated=true;}window._GLOBAL.data=data;window._BLOG=this;let theme=this.config.theme,themeURL=[theme.host,theme.namespace,'',].join('/');let templates={},length=Object.keys(theme.templates).length+Object.keys(theme.files).length,percent=50,count=0,prefix='themes/'+theme.namespace+'/';for(let name in theme.templates){count++;this.loader('Loading... [template:'+name+']',50+(count/length*percent));let tempURL=themeURL+theme.templates[name],file=prefix+'templates/'+name,text=await app.get(file);if(!text||!theme.save){text=await fetch(tempURL).then(r=>r.text()).catch(e=>alert(e));await app.put(file,text);}templates[name]=text;}window._GLOBAL['templates']=templates;for(let file of theme.files){let fileURL=themeURL+file,vfile=prefix+file,text=await app.get(vfile);if(!text||!theme.save){count++;this.loader('Loading... [file:'+file+']',50+(count/length*percent));text=await fetch(fileURL).then(r=>r.text()).catch(e=>alert(e));await app.put(vfile,text);}if(text){if(file.match(/\.css$/)){await app.exec(text,'style',file);}else if(file.match(/\.js$/)){await app.exec(text,'script',file);}}}this.loader('Loading...',100);this.route.init();if(!isUpdated){data=await this.requestData();app.put(dbpath,JSON.stringify(data));window._GLOBAL.data=data;}};this.requestData=async function(table){let data=[],host='https://api.github.com/repos',limit=this.db.config.host==host?0x64:1;for(let page=1;page<=limit;page++){let temp=await this.db.request(table,page);if(temp&&typeof temp==='object'){data=[...data,...Object.values(temp)];if(Object.keys(temp).length<30){break;}}else{break;}}return data;};this.test=function(a,b,c){let parse=new parser,loaded=[],sc=document.querySelectorAll('script[id]');for(let i=0;i<sc.length;i++){loaded.push(sc[i].id);}document.body.innerHTML='<pre>'+'[loaded.files]\n'+parse.likeJSON(loaded)+'\n\n'+'[stored.files]\n'+parse.likeJSON(this.virtual.list(true))+'\n\n'+'[config]\n'+parse.likeJSON(this.config,3)+'\n\n'+'[args]\n'+parse.likeJSON({arguments},5)+'\n\n'+'[this]\n'+parse.likeJSON(this,5)+'\n\n'+'</pre>'+'';};this.loader=function(str,cent){str=typeof str==='string'?str:'Loading...';let span=document.querySelector('span'),progress=document.querySelector('progress');if(span&&progress){if(typeof cent==='number'&&cent!==NaN){progress.max=100;progress.value=parseInt(cent);span.innerText=parseInt(cent)+'% '+str;}else{span.innerText=str;}return;}let img=this.loaderImage(),text=document.createTextNode(' '+str),pre=document.createElement('div');pre.style.padding='30px';pre.style.textAlign='center';pre.style.fontFamily='system-ui';pre.style.fontSize='16px';pre.style.color='#555';pre.appendChild(img);pre.appendChild(text);document.body.innerHTML='';document.body.appendChild(pre);return pre;};this.loaderImage=function(){let img=new Image;img.src=this.loaderURL();return img;};this.loaderURL=function(){return this.config.loader;};};/*** BlogDatabaseDriver* ~ blog database driver* authored by 9r3i* https://github.com/9r3i* started at november 22nd 2023* @usage: new BlogDatabaseDriver(config object,blog object)** [acceptable:host]* - api.github.com/repos (releases method, 30 rows per page)* - raw.githubusercontent.com (file method)* - relfo.vercel.app (release file method)* - sabunjelly.com (query method: kdb, ldb, sdb, jdb)* - 9r3i.web.id (query method: expired)* -** [sample:config]{"database": {"driver": "BlogDatabaseDriver","host": "https://raw.githubusercontent.com","username": "9r3i","password": "___GITHUB_PUBLIC_TOKEN___","name": "gaino-blog-data","tables": {"posts": "master/posts.json","authors": "master/authors.json"},"file": false,"fetch": "browser","expires": "Fri, Nov 23 2024"}}*/;function BlogDatabaseDriver(cnf,blg){Object.defineProperty(this,'version',{value:'1.0.0',writable:false,});this.config=cnf;this.blog=blg;this.init=function(){this.options={};};this.request=async function(table,page){table=typeof table==='string'&&this.config.tables.hasOwnProperty(table)?table:'posts';let path=[this.config.host,this.config.username,this.config.name,this.config.tables[table],];if(this.config.file){path.push(this.config.file);}let url=path.join('/')+(page?'?page='+page:'');if(this.config.fetch=='xhr'||this.config.fetch=='gaino'){if(!this.options.hasOwnProperty('error')){this.options.error=function(e){prompt(e,url);};}let res=await this.blog.gaino.fetch(url,this.options);return this.blog.gaino.parseJSON(res);}else if(this.config.fetch=='browser'){let res=await fetch(url,this.options).then(r=>r.json()).catch(e=>prompt(e,url));return res;}else{alert('Error: Requires database fetch.');return false;}};return this.init();};